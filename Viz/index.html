
<head>
  <!-- mapbox GL -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
  <!-- D3 -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/queue.v1.min.js"></script>

  <style>

    em{
        color: red;
        font-weight: bold;
    }

    body {
      padding: 0;
      margin: 0;
      font-family: Helvetica, Arial, sans-serif;
      font-size: 12px;
      font-style: bold;
      line-height: 18px;
      color:black;
    }

    html, body, #map {
        height: 100%;
    }
    svg {
        position: relative;
        width: 100%;
        height: 100%;
          }
    circle {
      fill: #ff5065;
      opacity:0.5;
    }
    circle:hover {
        stroke: red;
        fill-opacity:.1;
        fill:white;
        stroke-width: 3px;
        cursor: crosshair;
    }

    line {
      stroke:#A7A9AB;
      stroke-opacity:0;
      stroke-width: 1.0px;
      z-index:3;
    }

    div.tooltip{
      padding: 6px;
      background: white;
      visibility: hidden;
      position: absolute;
      z-index: 10;
    }
    p.tooltip-text{
      margin: 0px;
      padding: 0px;
      color:black;
    }

    div.menu{
        position: fixed;
        margin: 15px;
        padding: 20px;
        top: 0px;
        left: 0px;
        width: 200px;
        height: 700px;
        background: rgba(255,255,255,.8);
    }
  </style>
</head>
<body>
  <div id='map' style='width: 100%; height: 100%;'></div>
<script>


// reference: https://github.com/jorditost/mapboxgl-d3-playground/blob/master/02-mapbox-d3-points.html
  // mapbox initialization
  mapboxgl.accessToken = 'pk.eyJ1IjoiaXZyaWVsNTAxIiwiYSI6ImNqeW9uejl4dTE2dTkzY2xpdjkyZ2VpdHUifQ.OY_j0gmu8ib1A3wS6bsEHQ';
  var map = new mapboxgl.Map({
    container: 'map', //container id
    //need to go to mapbox studio to design map styles
    style: 'mapbox://styles/ivriel501/ck2wbr6tv1ayy1cpapltmttq3',
    center:[-122.358600, 37.748874],
    zoom:11.5
  });
    //mapbox + d3 connection

    // overlay d3 on the map
    //Get mapbox map canvas container
		var canvas = map.getCanvasContainer();

		//Overlay D3 on the map
		var svg = d3.select(canvas).append("svg");


    //load map and dataset
    map.on('load',function(){
      d3.json('data/sample_transbase_collisions_11082019.json').then(function(data){
        drawPoints(data);
      });
    });

    // Project GeoJSON coordinate to the map's current state
    function project(d) {
        return map.project(new mapboxgl.LngLat(+d[0], +d[1]));
    };
// //Project any point to map's current state
// 		function projectStream(lon, lat) {
// 			var point = map.project(new mapboxgl.LngLat(lon, lat));
// 			this.stream.point(point.x, point.y);
// 		}
//
//
//     // project function
//     var transform = d3.geoTransform({point: projectStream});
//   	var path = d3.geoPath().projection(transform);


    //D3 Stuff
    var circles;
    function drawPoints(data){
      console.log(data);

      //add points

      circles = svg.selectAll('circle')
              .data(data.features)
              .enter()
              .append('circle')
              .attr('r',3);

              function update(){
                console.log('update');

                circles.attr('cx', function(d) {
                  var coords = project(d.geometry.coordinates)
                  return coords.x
                })
                        .attr('cy', function(d) {
                  var coords = project(d.geometry.coordinates)
                  return coords.y
                });
              }
      // call the update function
      update();
      map.on("viewreset", update);
      map.on("move", update);
      map.on("moveend", update);
    }

    // Update d3 shapes' positions to the map's current state
    function update(){
      console.log('update');
    // get bounding box of data
      var bounds = path.bounds(data),
          topLeft = bounds[0],
          bottomRight = bounds[1];
          console.log(bounds);

      var buffer = 50000;


      // reposition the SVG to cover the features.
      svg.attr("width", bottomRight[0] - topLeft[0] + (buffer * 2))
         .attr("height", bottomRight[1] - topLeft[1] + (buffer * 2))
         .style("left", (topLeft[0] - buffer) + "px")
         .style("top", (topLeft[1] - buffer) + "px");
      svg.attr("transform", "translate(" + (-topLeft[0] + buffer) + "," + (-topLeft[1] + buffer) + ")");
      circles.attr('cx', function(d) {
        var coords = project(d.geometry.coordinates)
        return coords.x
      })
              .attr('cy', function(d) {
        var coords = project(d.geometry.coordinates)
        return coords.y
      });
    }












</script>

</body>
